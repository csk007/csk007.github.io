<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bomb Chip Challenge</title>
    <style>
        :root {
            --bg-color: #2c3e50;
            --chip-color: #ecf0f1;
            --accent-color: #3498db;
            --bomb-color: #e74c3c;
            --safe-color: #27ae60;
            --computer-color: #8e44ad;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            text-align: center;
        }

        h1 { margin-bottom: 5px; }
        
        #status {
            font-size: 1.2rem;
            margin-bottom: 20px;
            min-height: 50px;
            color: #f1c40f;
            padding: 0 10px;
        }

        /* The Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 10px;
            margin-bottom: 20px;
            display: none; /* Hidden until game starts */
        }

        .chip {
            background-color: var(--chip-color);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            transition: transform 0.1s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            user-select: none;
            color: #333;
        }

        .chip:active { transform: scale(0.95); }

        /* Chip States */
        .chip.selected { border: 5px solid var(--accent-color); }
        .chip.safe { background-color: var(--safe-color); animation: popIn 0.3s; color: white;}
        .chip.exploded { background-color: var(--bomb-color); animation: shake 0.5s; color: white;}

        /* UI Buttons */
        .btn {
            padding: 12px 24px;
            font-size: 1rem;
            cursor: pointer;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 5px;
            margin: 5px;
            transition: background 0.2s;
        }
        .btn:hover { background-color: #2980b9; }
        .btn-hide { display: none; }

        /* Menu Screen */
        #menu {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Animations */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        @keyframes popIn {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }

        /* Overlay */
        #overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
    </style>
</head>
<body>

    <h1>ðŸ’£ Bomb Chip Challenge</h1>
    <div id="status">Select a game mode to start</div>

    <div id="menu">
        <button class="btn" onclick="startGameMode('PVP')">2 Players (Pass & Play)</button>
        <button class="btn" onclick="startGameMode('PVC')">1 Player (Vs Computer)</button>
    </div>

    <div class="grid" id="gameGrid"></div>

    <button id="actionBtn" class="btn btn-hide" onclick="handleAction()">Confirm Hiding Spots</button>
    <button id="replayBtn" class="btn btn-hide" onclick="location.reload()">Play Again</button>

    <div id="overlay">
        <h2 id="overlayText">Pass Device</h2>
        <button id="overlayBtn" class="btn" onclick="dismissOverlay()">Ready</button>
    </div>

    <script>
        // --- Audio Context ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playBlastSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            gainNode.gain.setValueAtTime(1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        function playSafeSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(400, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        // --- Game Logic ---
        const grid = document.getElementById('gameGrid');
        const statusEl = document.getElementById('status');
        const actionBtn = document.getElementById('actionBtn');
        const replayBtn = document.getElementById('replayBtn');
        const menu = document.getElementById('menu');
        const overlay = document.getElementById('overlay');
        const overlayText = document.getElementById('overlayText');

        let isVsComputer = false;
        let gameState = 'MENU'; // MENU, SETUP_P1, SETUP_P2, PLAY_P1, PLAY_P2, PLAY_CPU, GAME_OVER
        let p1HiddenBombs = [];
        let p2HiddenBombs = []; // Computer uses this as its bomb array
        let p1BombsTriggered = 0;
        let p2BombsTriggered = 0;
        
        // 0=unknown, 1=safe, 2=exploded
        let p1ViewOfP2Board = Array(9).fill(0); 
        let p2ViewOfP1Board = Array(9).fill(0);

        function startGameMode(mode) {
            isVsComputer = (mode === 'PVC');
            menu.style.display = 'none';
            grid.style.display = 'grid';
            initGrid();
            
            gameState = 'SETUP_P1';
            statusEl.innerText = "Player 1: Tap 3 chips to hide your bombs.";
        }

        function initGrid() {
            grid.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                let chip = document.createElement('div');
                chip.classList.add('chip');
                chip.dataset.index = i;
                chip.onclick = () => handleChipClick(i);
                grid.appendChild(chip);
            }
        }

        function handleChipClick(index) {
            if (gameState === 'GAME_OVER' || gameState === 'PLAY_CPU') return;

            const chips = document.querySelectorAll('.chip');

            // --- SETUP PHASE ---
            if (gameState === 'SETUP_P1' || gameState === 'SETUP_P2') {
                let currentArray = (gameState === 'SETUP_P1') ? p1HiddenBombs : p2HiddenBombs;
                
                if (currentArray.includes(index)) {
                    currentArray = currentArray.filter(i => i !== index);
                    chips[index].classList.remove('selected');
                    chips[index].innerHTML = "";
                } else {
                    if (currentArray.length < 3) {
                        currentArray.push(index);
                        chips[index].classList.add('selected');
                        chips[index].innerHTML = "ðŸ’£";
                    }
                }

                if (gameState === 'SETUP_P1') p1HiddenBombs = currentArray;
                else p2HiddenBombs = currentArray;

                let count = currentArray.length;
                statusEl.innerText = `Hiding Bombs: ${count}/3 placed.`;
                actionBtn.style.display = (count === 3) ? 'inline-block' : 'none';
            }

            // --- PLAY PHASE (HUMAN) ---
            else if (gameState === 'PLAY_P1' || gameState === 'PLAY_P2') {
                let currentView = (gameState === 'PLAY_P1') ? p1ViewOfP2Board : p2ViewOfP1Board;
                
                // If tile already revealed, ignore
                if (currentView[index] !== 0) return;

                processMove(index);
            }
        }

        function processMove(index) {
            const chips = document.querySelectorAll('.chip');
            let isP1Turn = (gameState === 'PLAY_P1');
            
            // Determine whose bombs we are checking against
            let opponentBombs = isP1Turn ? p2HiddenBombs : p1HiddenBombs;
            let currentView = isP1Turn ? p1ViewOfP2Board : p2ViewOfP1Board;
            let playerLabel = isP1Turn ? "Player 1" : (isVsComputer ? "Computer" : "Player 2");

            if (opponentBombs.includes(index)) {
                // HIT BOMB
                playBlastSound();
                chips[index].classList.add('exploded');
                chips[index].innerHTML = "ðŸ’¥";
                currentView[index] = 2;

                if (isP1Turn) p1BombsTriggered++;
                else p2BombsTriggered++;

                statusEl.innerText = `${playerLabel} HIT A BOMB!`;

                if (checkWinCondition()) return; // Stop if game ended

            } else {
                // SAFE
                playSafeSound();
                chips[index].classList.add('safe');
                currentView[index] = 1;
                statusEl.innerText = `${playerLabel} is Safe.`;
            }

            // Switch turn delay
            setTimeout(switchTurn, 1500);
        }

        function handleAction() {
            if (gameState === 'SETUP_P1') {
                if (isVsComputer) {
                    // Generate Computer Bombs
                    computerHideBombs();
                    gameState = 'PLAY_P1';
                    resetGridVisuals();
                    statusEl.innerText = "Game Start! Tap a chip to find Computer's bombs.";
                    actionBtn.style.display = 'none';
                } else {
                    showOverlay("Pass device to Player 2", () => {
                        gameState = 'SETUP_P2';
                        resetGridVisuals();
                        statusEl.innerText = "Player 2: Hide your 3 bombs.";
                        actionBtn.style.display = 'none';
                    });
                }
            } else if (gameState === 'SETUP_P2') {
                showOverlay("Setup Complete! Pass to Player 1 to start.", () => {
                    gameState = 'PLAY_P1';
                    resetGridVisuals();
                    statusEl.innerText = "Player 1's Turn: Tap a chip to find bombs.";
                    actionBtn.style.display = 'none';
                });
            }
        }

        function computerHideBombs() {
            p2HiddenBombs = [];
            while(p2HiddenBombs.length < 3) {
                let r = Math.floor(Math.random() * 9);
                if(!p2HiddenBombs.includes(r)) p2HiddenBombs.push(r);
            }
        }

        function switchTurn() {
            if (gameState === 'GAME_OVER') return;

            if (gameState === 'PLAY_P1') {
                // P1 just finished. Now it's P2 or CPU.
                if (isVsComputer) {
                    // CPU Turn
                    gameState = 'PLAY_CPU';
                    
                    // Show P1's board (so P1 can see where they are getting hit)
                    // We render p2ViewOfP1Board (which tracks what CPU has seen of P1)
                    // BUT we also want to show P1 where their hidden bombs are (transparency)
                    renderBoardState(p2ViewOfP1Board, p1HiddenBombs); 
                    statusEl.innerText = `Computer's Turn...`;
                    
                    setTimeout(computerAI, 1000);

                } else {
                    // P2 Turn (Human)
                    showOverlay("Pass device to Player 2", () => {
                        gameState = 'PLAY_P2';
                        renderBoardState(p2ViewOfP1Board); // Show what P2 has revealed of P1
                        statusEl.innerText = `Player 2's Turn (Bombs hit: ${p2BombsTriggered}/3)`;
                    });
                }
            } else {
                // P2/CPU just finished. Back to P1.
                if (isVsComputer) {
                    gameState = 'PLAY_P1';
                    renderBoardState(p1ViewOfP2Board); // Show what P1 has revealed of CPU
                    statusEl.innerText = `Your Turn (Bombs hit: ${p1BombsTriggered}/3)`;
                } else {
                    showOverlay("Pass device to Player 1", () => {
                        gameState = 'PLAY_P1';
                        renderBoardState(p1ViewOfP2Board);
                        statusEl.innerText = `Player 1's Turn (Bombs hit: ${p1BombsTriggered}/3)`;
                    });
                }
            }
        }

        function computerAI() {
            // Find valid moves (indices where view is 0)
            let validMoves = [];
            for(let i=0; i<9; i++) {
                if(p2ViewOfP1Board[i] === 0) validMoves.push(i);
            }

            if(validMoves.length > 0) {
                let randomMove = validMoves[Math.floor(Math.random() * validMoves.length)];
                
                // Reuse processMove logic. 
                // Note: processMove checks gameState to know who is playing.
                // We are in PLAY_CPU state, which isn't PLAY_P1, so processMove treats it as P2/CPU.
                processMove(randomMove);
            }
        }

        // Render the board based on what has been revealed.
        // optionalRevealArray: Used in Vs Computer mode so P1 can see their own hidden bombs while CPU plays.
        function renderBoardState(viewArray, optionalHiddenBombs = []) {
            const chips = document.querySelectorAll('.chip');
            chips.forEach((chip, i) => {
                chip.className = 'chip'; // Reset
                chip.innerHTML = '';
                
                // If it's P1 watching CPU play, show P1's hidden bombs faintly
                if (optionalHiddenBombs.includes(i) && viewArray[i] === 0) {
                    chip.innerHTML = "ðŸ’£";
                    chip.style.opacity = "0.5"; 
                } else {
                    chip.style.opacity = "1";
                }

                if (viewArray[i] === 1) {
                    chip.classList.add('safe');
                } else if (viewArray[i] === 2) {
                    chip.classList.add('exploded');
                    chip.innerHTML = "ðŸ’¥";
                }
            });
        }

        function resetGridVisuals() {
            const chips = document.querySelectorAll('.chip');
            chips.forEach(chip => {
                chip.className = 'chip';
                chip.innerHTML = '';
                chip.style.opacity = "1";
            });
        }

        function checkWinCondition() {
            if (p1BombsTriggered === 3) {
                endGame(isVsComputer ? "You hit 3 bombs. Computer WINS!" : "Player 1 hit 3 bombs. Player 2 WINS!");
                return true;
            } else if (p2BombsTriggered === 3) {
                endGame(isVsComputer ? "Computer hit 3 bombs. YOU WIN!" : "Player 2 hit 3 bombs. Player 1 WINS!");
                return true;
            }
            return false;
        }

        function endGame(msg) {
            gameState = 'GAME_OVER';
            statusEl.innerText = msg;
            statusEl.style.color = '#e74c3c';
            statusEl.style.fontWeight = 'bold';
            replayBtn.style.display = 'inline-block';
        }

        function showOverlay(text, callback) {
            overlayText.innerText = text;
            overlay.style.display = 'flex';
            document.getElementById('overlayBtn').onclick = () => {
                overlay.style.display = 'none';
                if (callback) callback();
            };
        }

        function dismissOverlay() {
            overlay.style.display = 'none';
        }

    </script>
</body>
</html>